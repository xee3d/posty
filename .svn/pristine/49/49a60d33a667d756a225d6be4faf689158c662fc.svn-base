import React, { useState, useRef, useEffect } from 'react';
import {
  View,
  StyleSheet,
  StatusBar,
  Animated,
  Dimensions,
} from 'react-native';

// Import screens
import HomeScreen from './src/screens/HomeScreen';
import AIWriteScreen from './src/screens/AIWriteScreen';
// import TrendScreen from './src/screens/TrendScreen'; // íŠ¸ë Œë“œ íƒ­ ì œê±°
import MyStyleScreen from './src/screens/MyStyleScreen';
import SettingsScreen from './src/screens/SettingsScreen';
import FeedWithAdsExample from './src/screens/FeedWithAdsExample';
import SubscriptionScreen from './src/screens/SubscriptionScreen';
import TabNavigator from './src/components/TabNavigator';

// Import constants and hooks
import { COLORS } from './src/utils/constants';
import { useAppTheme } from './src/hooks/useAppTheme';

// Import services
import adService from './src/services/adService';
import subscriptionService from './src/services/subscriptionService';
import soundManager from './src/utils/soundManager';

const { width } = Dimensions.get('window');

const App: React.FC = () => {
  const { colors, isDark } = useAppTheme();
  const [activeTab, setActiveTab] = useState('home');
  const [isAnimating, setIsAnimating] = useState(false);
  const [photoMode, setPhotoMode] = useState(false);
  const [navigationData, setNavigationData] = useState<any>(null);
  
  const fadeAnim = useRef(new Animated.Value(1)).current;
  const translateXAnim = useRef(new Animated.Value(0)).current;

  // ê´‘ê³  ë° êµ¬ë… ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
  useEffect(() => {
    // ê°œë°œ ëª¨ë“œì—ì„œ ê²½ê³  í™•ì¸
    if (__DEV__) {
      console.log('ðŸš€ Posty App Started in Development Mode');
      console.log('React Native Version:', require('react-native/package.json').version);
    }

    const initializeServices = async () => {
      try {
        await adService.initialize();
        await subscriptionService.initialize();
        console.log('âœ… Services initialized successfully');
      } catch (error) {
        console.error('âŒ Failed to initialize services:', error);
      }
    };
    
    initializeServices();
  }, []);

  const handleTabPress = (tab: string, data?: any) => {
    // console.log('handleTabPress called with:', { tab, data });
    if (isAnimating || (tab === activeTab && tab !== 'ai-write-photo')) return;
    
    // ì „ë‹¬ë°›ì€ ë°ì´í„° ì €ìž¥
    setNavigationData(data);
    
    // ì‚¬ì§„ ëª¨ë“œ ì²˜ë¦¬
    if (tab === 'ai-write-photo') {
      setPhotoMode(true);
      tab = 'ai-write';
    } else {
      setPhotoMode(false);
    }
    
    setIsAnimating(true);
    
    const tabs = ['home', 'ai-write', 'my-style', 'settings'];
    const currentIndex = tabs.indexOf(activeTab);
    const nextIndex = tabs.indexOf(tab);
    const direction = nextIndex > currentIndex ? 1 : -1;
    
    // í˜„ìž¬ í™”ë©´ íŽ˜ì´ë“œ ì•„ì›ƒ
    Animated.parallel([
      Animated.timing(fadeAnim, {
        toValue: 0,
        duration: 100, // 150ì—ì„œ 100ìœ¼ë¡œ ë‹¨ì¶•
        useNativeDriver: true,
      }),
      Animated.timing(translateXAnim, {
        toValue: -direction * 20, // 30ì—ì„œ 20ìœ¼ë¡œ ê°ì†Œ
        duration: 100,
        useNativeDriver: true,
      }),
    ]).start(() => {
      // í™”ë©´ ì „í™˜
      setActiveTab(tab);
      
      // ìƒˆ í™”ë©´ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
      translateXAnim.setValue(direction * 20);
      
      // ìƒˆ í™”ë©´ íŽ˜ì´ë“œ ì¸
      Animated.parallel([
        Animated.timing(fadeAnim, {
          toValue: 1,
          duration: 150, // 200ì—ì„œ 150ìœ¼ë¡œ ë‹¨ì¶•
          useNativeDriver: true,
        }),
        Animated.spring(translateXAnim, {
          toValue: 0,
          friction: 10, // 8ì—ì„œ 10ìœ¼ë¡œ ì¦ê°€ (ë” ë¹ ë¥¸ ì •ì§€)
          tension: 80, // 40ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€ (ë” ë¹ ë¥¸ ìŠ¤í”„ë§)
          useNativeDriver: true,
        }),
      ]).start(() => {
        setIsAnimating(false);
      });
    });
    
    // ì‚¬ìš© í›„ ë°ì´í„° ì´ˆê¸°í™” - ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ì—ë§Œ
    // setNavigationData(null); // ì£¼ì„ ì²˜ë¦¬ - ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
  };

  const renderScreen = () => {
    switch (activeTab) {
      case 'home':
        return <HomeScreen key="home" onNavigate={handleTabPress} />;
      case 'ai-write':
        return (
          <AIWriteScreen 
            key={`ai-write-${activeTab}`} 
            onNavigate={handleTabPress} 
            initialMode={navigationData?.initialMode || (photoMode ? 'photo' : 'text')} 
            initialText={navigationData?.content}
            initialHashtags={navigationData?.hashtags}
            initialTitle={navigationData?.title}
          />
        );
      // case 'trend':
      //   return <TrendScreen key="trend" onNavigate={handleTabPress} />;
      case 'my-style':
        return <MyStyleScreen key="my-style" onNavigate={handleTabPress} />;
      case 'settings':
        return <SettingsScreen key="settings" onNavigate={handleTabPress} />;
      case 'feed-ads':
        return <FeedWithAdsExample key="feed-ads" navigation={{ navigate: handleTabPress }} />;
      case 'subscription':
        return <SubscriptionScreen key="subscription" navigation={{ goBack: () => handleTabPress('home'), navigate: handleTabPress }} />;
      default:
        return <HomeScreen key="home" onNavigate={handleTabPress} />;
    }
  };

  const styles = createStyles(colors);

  return (
    <View style={styles.container}>
      <StatusBar 
        backgroundColor={colors.surface} 
        barStyle={isDark ? "light-content" : "dark-content"} 
      />
      <Animated.View 
        style={[
          styles.content,
          {
            opacity: fadeAnim,
            transform: [{ translateX: translateXAnim }],
          },
        ]}
      >
        {renderScreen()}
      </Animated.View>
      <TabNavigator 
        activeTab={activeTab} 
        onTabPress={handleTabPress} 
      />
    </View>
  );
};

const createStyles = (colors: typeof COLORS) => 
  StyleSheet.create({
    container: {
      flex: 1,
      backgroundColor: colors.background,
    },
    content: {
      flex: 1,
    },
  });

export default App;
