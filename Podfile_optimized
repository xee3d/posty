require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

platform :ios, min_ios_version_supported
prepare_react_native_project!

# Flipper ë¹„í™œì„±í™” (ì•ˆì •ì„±ì„ ìœ„í•´)
flipper_config = FlipperConfiguration.disabled

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

target 'Posty' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    :flipper_configuration => flipper_config,
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  # Firebase ì˜ì¡´ì„± (ë²„ì „ ëª…ì‹œ)
  pod 'Firebase/Analytics', '~> 10.0'
  pod 'Firebase/Auth', '~> 10.0'
  pod 'Firebase/Firestore', '~> 10.0'

  # React Native Firebase
  pod 'RNFBApp', :path => '../node_modules/@react-native-firebase/app'
  pod 'RNFBAuth', :path => '../node_modules/@react-native-firebase/auth'
  pod 'RNFBFirestore', :path => '../node_modules/@react-native-firebase/firestore'
  pod 'RNFBAnalytics', :path => '../node_modules/@react-native-firebase/analytics'

  # Google Sign In
  pod 'GoogleSignIn', '~> 7.0'
  pod 'RNGoogleSignin', :path => '../node_modules/@react-native-google-signin/google-signin'

  # Apple Authentication
  pod 'RNAppleAuthentication', :path => '../node_modules/@invertase/react-native-apple-authentication'

  # Social Login SDKs
  pod 'KakaoSDK'
  
  # Facebook SDK (í•„ìš”ì‹œ)
  # pod 'FBSDKCoreKit'
  # pod 'FBSDKLoginKit'

  # Media & Camera
  pod 'react-native-image-picker', :path => '../node_modules/react-native-image-picker'
  pod 'react-native-image-resizer', :path => '../node_modules/react-native-image-resizer'

  # Audio
  pod 'react-native-sound', :path => '../node_modules/react-native-sound'

  # In-App Purchase
  pod 'react-native-iap', :path => '../node_modules/react-native-iap'

  # Permissions
  pod 'Permission-Camera', :path => "../node_modules/react-native-permissions/ios/Camera"
  pod 'Permission-PhotoLibrary', :path => "../node_modules/react-native-permissions/ios/PhotoLibrary"
  pod 'Permission-Microphone', :path => "../node_modules/react-native-permissions/ios/Microphone"
  pod 'Permission-LocationWhenInUse', :path => "../node_modules/react-native-permissions/ios/LocationWhenInUse"

  # AdMob (í•„ìš”ì‹œ)
  # pod 'Google-Mobile-Ads-SDK', '~> 10.0'

  target 'PostyTests' do
    inherit! :complete
  end

  post_install do |installer|
    # React Native ê¸°ë³¸ ì„¤ì •
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )
    
    # ëª¨ë“  íƒ€ê²Ÿì— ëŒ€í•œ ë¹Œë“œ ì„¤ì • í†µì¼
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Swift ë²„ì „ í†µì¼
        config.build_settings['SWIFT_VERSION'] = '5.9'
        
        # iOS ë°°í¬ íƒ€ê²Ÿ í†µì¼
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
        
        # Bitcode ë¹„í™œì„±í™” (React Native í˜¸í™˜ì„±)
        config.build_settings['ENABLE_BITCODE'] = 'NO'
        
        # ì•„í‚¤í…ì²˜ ì„¤ì • (Apple Silicon Mac í˜¸í™˜ì„±)
        if target.name == 'React-Core' or target.name.start_with?('React-')
          config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
        end
        
        # ì»´íŒŒì¼ëŸ¬ í”Œë˜ê·¸
        config.build_settings['OTHER_CFLAGS'] = '-DFOLLY_NO_CONFIG -DFOLLY_MOBILE=1 -DFOLLY_USE_LIBCPP=1'
        
        # ë§ì»¤ í”Œë˜ê·¸
        config.build_settings['OTHER_LDFLAGS'] = '-ObjC'
        
        # í—¤ë” ê²€ìƒ‰ ê²½ë¡œ
        config.build_settings['HEADER_SEARCH_PATHS'] ||= []
        config.build_settings['HEADER_SEARCH_PATHS'] << '$(SRCROOT)/../node_modules/react-native/React/**'
        
        # ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²€ìƒ‰ ê²½ë¡œ
        config.build_settings['LIBRARY_SEARCH_PATHS'] ||= []
        config.build_settings['LIBRARY_SEARCH_PATHS'] << '$(SRCROOT)/../node_modules/react-native/ReactCommon/**'
        
        # í”„ë ˆì„ì›Œí¬ ê²€ìƒ‰ ê²½ë¡œ
        config.build_settings['FRAMEWORK_SEARCH_PATHS'] ||= []
        config.build_settings['FRAMEWORK_SEARCH_PATHS'] << '$(SRCROOT)/../node_modules/react-native/React/**'
      end
    end
    
    # Firebase íŠ¹ë³„ ì„¤ì • (iOS 11.0+ í˜¸í™˜ì„±)
    installer.pods_project.targets.each do |target|
      if target.name.start_with?('Firebase')
        target.build_configurations.each do |config|
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
        end
      end
    end
    
    # Google SDK íŠ¹ë³„ ì„¤ì •
    installer.pods_project.targets.each do |target|
      if target.name.start_with?('Google')
        target.build_configurations.each do |config|
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
          config.build_settings['SWIFT_VERSION'] = '5.9'
        end
      end
    end
    
    # KakaoSDK íŠ¹ë³„ ì„¤ì •
    installer.pods_project.targets.each do |target|
      if target.name.start_with?('Kakao')
        target.build_configurations.each do |config|
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
          config.build_settings['SWIFT_VERSION'] = '5.9'
        end
      end
    end
    
    # React Native ê´€ë ¨ íƒ€ê²Ÿë“¤ì— ëŒ€í•œ íŠ¹ë³„ ì„¤ì •
    installer.pods_project.targets.each do |target|
      if target.name.start_with?('React') || target.name.start_with?('RCT') || target.name.start_with?('RN')
        target.build_configurations.each do |config|
          # C++ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
          config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
          config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
          
          # ARC ì„¤ì •
          config.build_settings['CLANG_ENABLE_OBJC_ARC'] = 'YES'
          
          # ëª¨ë“ˆ ì„¤ì •
          config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
          
          # ê²½ê³  ì„¤ì •
          config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
          config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'
        end
      end
    end
    
    # ëª¨ë“  íƒ€ê²Ÿì— ëŒ€í•œ ê³µí†µ ìµœì í™” ì„¤ì •
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # ë””ë²„ê·¸ ì •ë³´ í¬ë§·
        config.build_settings['DEBUG_INFORMATION_FORMAT'] = 'dwarf-with-dsym'
        
        # ì»´íŒŒì¼ ìµœì í™”
        if config.name == 'Release'
          config.build_settings['GCC_OPTIMIZATION_LEVEL'] = '3'
          config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-O'
        else
          config.build_settings['GCC_OPTIMIZATION_LEVEL'] = '0'
          config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
        end
        
        # ì£½ì€ ì½”ë“œ ì œê±°
        config.build_settings['DEAD_CODE_STRIPPING'] = 'YES'
        
        # ìŠ¤íŠ¸ë¦½ ì„¤ì •
        config.build_settings['STRIP_INSTALLED_PRODUCT'] = config.name == 'Release' ? 'YES' : 'NO'
        
        # ì‹¬ë³¼ ìˆ¨ê¹€
        config.build_settings['GCC_SYMBOLS_PRIVATE_EXTERN'] = 'YES'
      end
    end
    
    puts "âœ… Podfile post_install ì„¤ì • ì™„ë£Œ"
    puts "ğŸ“± iOS 11.0+ í˜¸í™˜ì„± í™•ë³´"
    puts "ğŸ”§ Swift 5.9 ë²„ì „ í†µì¼"
    puts "ğŸš€ React Native 0.74.5 ìµœì í™” ì ìš©"
  end
end
