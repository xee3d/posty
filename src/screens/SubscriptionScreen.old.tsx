import React, { useState, useEffect } from "react";
import {
  View,
  Text,
  ScrollView,
  TouchableOpacity,
  StyleSheet,
  SafeAreaView,
  Dimensions,
  Linking,
  Share,
  Platform,
} from "react-native";
import { COLORS, SPACING, BRAND } from "../utils/constants";
import { SUBSCRIPTION_PLANS, TOKEN_USAGE } from "../utils/adConfig";
import Icon from "react-native-vector-icons/MaterialIcons";
import { useAppTheme } from "../hooks/useAppTheme";
import { useAppSelector, useAppDispatch } from "../hooks/redux";
import {
  selectCurrentTokens,
  selectSubscriptionPlan,
} from "../store/slices/userSlice";
import EarnTokenModal from "../components/EarnTokenModal";
import tokenService from "../services/subscription/tokenService";
import inAppPurchaseService from "../services/subscription/inAppPurchaseService";
import AsyncStorage from "@react-native-async-storage/async-storage";
import rewardAdService from "../services/rewardAdService";
import missionService from "../services/missionService";
import TokenPurchaseView from "../components/TokenPurchaseView";
import ModernSubscriptionView from "../components/ModernSubscriptionView";

import { Alert } from "../utils/customAlert";
const { width: screenWidth } = Dimensions.get("window");

interface SubscriptionScreenProps {
  navigation: any;
  currentPlan?: "free" | "premium" | "pro";
}

export const SubscriptionScreen: React.FC<SubscriptionScreenProps> = ({
  navigation,
  currentPlan = "free",
}) => {
  const { colors, isDark } = useAppTheme();
  const dispatch = useAppDispatch();
  const currentTokens = useAppSelector(selectCurrentTokens);
  const subscriptionPlan = useAppSelector(selectSubscriptionPlan);
  const [selectedPlan, setSelectedPlan] = useState<"free" | "premium" | "pro">(
    "premium"
  );
  const [activeTab, setActiveTab] = useState<
    "subscription" | "tokens" | "manage"
  >("subscription");
  const [showEarnTokenModal, setShowEarnTokenModal] = useState(false);
  const [stats, setStats] = useState({
    totalTokens: 0,
  });
  const [realSubscriptionPlan, setRealSubscriptionPlan] = useState<
    "free" | "premium" | "pro"
  >("free");
  const [adStats, setAdStats] = useState({
    dailyCount: 0,
    remainingToday: 10,
  });

  useEffect(() => {
    loadTokenStats();
    loadAdStats();

    // Ï¥àÍ∏∞ ÌÉ≠ ÏÑ§Ï†ï ÌôïÏù∏
    const checkInitialTab = async () => {
      const initialTab = await AsyncStorage.getItem("subscription_initial_tab");
      if (initialTab) {
        setActiveTab(initialTab as any);
        await AsyncStorage.removeItem("subscription_initial_tab");
      }
    };
    checkInitialTab();

    // Î¶¨ÏõåÎìú Í¥ëÍ≥† ÎØ∏Î¶¨ Î°úÎìú
    rewardAdService.preloadAd();
  }, []);

  // ÌÜ†ÌÅ∞ Í¥ÄÎ¶¨ ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎê† ÎïåÎßàÎã§ ÏÉàÎ°úÍ≥†Ïπ®
  useEffect(() => {
    if (activeTab === "manage") {
      loadTokenStats();
      loadAdStats();
    }
  }, [activeTab]);

  const loadTokenStats = async () => {
    try {
      const tokenInfo = await tokenService.getTokenInfo();
      const totalTokens = tokenInfo.daily + tokenInfo.purchased;

      setStats({
        totalTokens: totalTokens,
      });

      setRealSubscriptionPlan(tokenInfo.plan || "free");
    } catch (error) {
      console.error("Failed to load token stats:", error);
    }
  };

  const loadAdStats = async () => {
    try {
      const stats = await rewardAdService.getAdStats();
      setAdStats({
        dailyCount: stats.dailyCount,
        remainingToday: stats.remainingDaily,
      });
    } catch (error) {
      console.error("Failed to load ad stats:", error);
    }
  };

  const handleEarnTokens = async (tokens: number) => {
    try {
      const subscription = await tokenService.getSubscription();
      subscription.dailyTokens += tokens;
      await AsyncStorage.setItem(
        "USER_SUBSCRIPTION",
        JSON.stringify(subscription)
      );

      await loadTokenStats();

      Alert.alert("ÌÜ†ÌÅ∞ ÌöçÎìù! üéâ", `${tokens}Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞õÏïòÏñ¥Ïöî!`, [
        { text: "ÌôïÏù∏" },
      ]);
    } catch (error) {
      console.error("Failed to add tokens:", error);
    }
  };

  // Í∞Å Î¨¥Î£å ÌÜ†ÌÅ∞ Ìï≠Î™©Ïóê ÎåÄÌïú Í∞úÎ≥Ñ Ìï∏Îì§Îü¨
  const handleWatchAd = async () => {
    const { canWatch, reason } = await rewardAdService.canWatchAd();

    if (!canWatch) {
      Alert.alert("Í¥ëÍ≥† ÏãúÏ≤≠ Î∂àÍ∞Ä", reason || "Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }

    Alert.alert(
      "Í¥ëÍ≥† ÏãúÏ≤≠",
      "30Ï¥à Í¥ëÍ≥†Î•º ÏãúÏ≤≠ÌïòÍ≥† 2Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞õÏúºÏãúÍ≤†Ïñ¥Ïöî?",
      [
        { text: "Ï∑®ÏÜå", style: "cancel" },
        {
          text: "ÏãúÏ≤≠ÌïòÍ∏∞",
          onPress: async () => {
            const result = await rewardAdService.showRewardedAd();

            if (result.success && result.reward) {
              await handleEarnTokens(result.reward.amount);

              // ÎØ∏ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
              const missionResult = await missionService.trackAction(
                "ad_watch"
              );
              if (missionResult.rewardsEarned > 0) {
                setTimeout(() => {
                  Alert.alert(
                    "ÎØ∏ÏÖò ÏôÑÎ£å! üéØ",
                    `Í¥ëÍ≥† ÏãúÏ≤≠ ÎØ∏ÏÖòÏùÑ ÏôÑÎ£åÌïòÏó¨ Ï∂îÍ∞ÄÎ°ú ${missionResult.rewardsEarned}Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞õÏïòÏäµÎãàÎã§!`,
                    [
                      {
                        text: "ÌôïÏù∏",
                        onPress: () =>
                          handleEarnTokens(missionResult.rewardsEarned),
                      },
                    ]
                  );
                }, 1000);
              }

              await loadAdStats();
            } else if (result.error) {
              Alert.alert("Í¥ëÍ≥† ÏãúÏ≤≠ Ïã§Ìå®", result.error);
            }
          },
        },
      ]
    );
  };

  const handleDailyCheck = async () => {
    // Ïò§Îäò Ïù¥ÎØ∏ Î∞õÏïòÎäîÏßÄ ÌôïÏù∏
    const today = new Date().toDateString();
    const lastCheck = await AsyncStorage.getItem("last_daily_check");

    if (lastCheck === today) {
      Alert.alert("ÏïåÎ¶º", "Ïò§ÎäòÏùÄ Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤¥ÌÅ¨Î•º ÌñàÏñ¥Ïöî!");
      return;
    }

    // Ï∂úÏÑù ÏÑ±Í≥µ
    await AsyncStorage.setItem("last_daily_check", today);
    await handleEarnTokens(1);

    // ÎØ∏ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
    const result = await missionService.trackAction("login");
    if (result.rewardsEarned > 0) {
      Alert.alert(
        "ÎØ∏ÏÖò ÏôÑÎ£å! üéØ",
        `Ï∂úÏÑù ÎØ∏ÏÖòÏùÑ ÏôÑÎ£åÌïòÏó¨ Ï∂îÍ∞ÄÎ°ú ${result.rewardsEarned}Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞õÏïòÏäµÎãàÎã§!`
      );
      await handleEarnTokens(result.rewardsEarned);
    }
  };

  const handleShareSNS = async () => {
    try {
      const result = await Share.share({
        message:
          "PostyÎ°ú AIÍ∞Ä ÎßåÎìúÎäî SNS ÏΩòÌÖêÏ∏†! ÏßÄÍ∏à Î∞îÎ°ú ÏÇ¨Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî üöÄ\nhttps://posty.app",
        title: "Posty - AI ÏΩòÌÖêÏ∏† ÏÉùÏÑ±",
      });

      if (result.action === Share.sharedAction) {
        // Í≥µÏú† ÏÑ±Í≥µ
        const today = new Date().toDateString();
        const sharedToday = await AsyncStorage.getItem(`shared_sns_${today}`);

        if (!sharedToday) {
          await AsyncStorage.setItem(`shared_sns_${today}`, "true");
          await handleEarnTokens(3);

          // ÎØ∏ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
          const missionResult = await missionService.trackAction("share");
          if (missionResult.rewardsEarned > 0) {
            Alert.alert(
              "ÎØ∏ÏÖò ÏôÑÎ£å! üéØ",
              `Í≥µÏú† ÎØ∏ÏÖòÏùÑ ÏôÑÎ£åÌïòÏó¨ Ï∂îÍ∞ÄÎ°ú ${missionResult.rewardsEarned}Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞õÏïòÏäµÎãàÎã§!`
            );
            await handleEarnTokens(missionResult.rewardsEarned);
          }
        } else {
          Alert.alert("ÏïåÎ¶º", "Ïò§ÎäòÏùÄ Ïù¥ÎØ∏ SNS Í≥µÏú†Î•º ÌñàÏñ¥Ïöî!");
        }
      }
    } catch (error) {
      console.error("Share error:", error);
    }
  };

  const handleInviteFriend = async () => {
    try {
      // ÏπúÍµ¨ Ï¥àÎåÄ ÏΩîÎìú ÏÉùÏÑ±
      const inviteCode = Math.random()
        .toString(36)
        .substring(2, 8)
        .toUpperCase();
      const inviteLink = `https://posty.app/invite/${inviteCode}`;

      const result = await Share.share({
        message: `PostyÎ°ú ÏπúÍµ¨Î•º Ï¥àÎåÄÌïòÏÑ∏Ïöî! Ï¥àÎåÄ ÏΩîÎìú: ${inviteCode}\n${inviteLink}`,
        title: "Posty Ï¥àÎåÄÌïòÍ∏∞",
      });

      if (result.action === Share.sharedAction) {
        Alert.alert(
          "Ï¥àÎåÄ Ï†ÑÏÜ°",
          "ÏπúÍµ¨Í∞Ä Í∞ÄÏûÖÌïòÎ©¥ 5Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî!",
          [{ text: "ÌôïÏù∏" }]
        );

        await missionService.trackAction("invite");
      }
    } catch (error) {
      console.error("Invite error:", error);
    }
  };

  const handleRateApp = async () => {
    // Ïù¥ÎØ∏ ÌèâÍ∞ÄÌñàÎäîÏßÄ ÌôïÏù∏
    const hasRated = await AsyncStorage.getItem("app_rated");

    if (hasRated) {
      Alert.alert("ÏïåÎ¶º", "Ïù¥ÎØ∏ Ïï±ÏùÑ ÌèâÍ∞ÄÌï¥Ï£ºÏÖ®Ïñ¥Ïöî. Í∞êÏÇ¨Ìï©ÎãàÎã§!");
      return;
    }

    Alert.alert("Ïï± ÌèâÍ∞ÄÌïòÍ∏∞", "PostyÍ∞Ä ÎèÑÏõÄÏù¥ ÎêòÏÖ®ÎÇòÏöî? ÌèâÍ∞ÄÎ•º ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî!", [
      { text: "ÎÇòÏ§ëÏóê", style: "cancel" },
      {
        text: "ÌèâÍ∞ÄÌïòÎü¨ Í∞ÄÍ∏∞",
        onPress: async () => {
          try {
            const storeUrl =
              Platform.OS === "ios"
                ? "https://apps.apple.com/app/posty-ai/id123456789" // Ïã§Ï†ú App Store ID
                : "https://play.google.com/store/apps/details?id=com.posty.ai";

            await Linking.openURL(storeUrl);

            // ÌèâÍ∞Ä ÏôÑÎ£åÎ°ú Í∞ÑÏ£º (Ïã§Ï†úÎ°úÎäî ÌôïÏù∏ Î∂àÍ∞Ä)
            setTimeout(async () => {
              await AsyncStorage.setItem("app_rated", "true");
              await handleEarnTokens(10);
            }, 3000);
          } catch (error) {
            Alert.alert("Ïò§Î•ò", "Ïä§ÌÜ†Ïñ¥Î•º Ïó¥ Ïàò ÏóÜÏñ¥Ïöî.");
          }
        },
      },
    ]);
  };

  const handleSubscribe = async () => {
    if (selectedPlan === "free") {
      navigation.goBack();
      return;
    }

    Alert.alert(
      "Íµ¨ÎèÖ ÌôïÏù∏",
      `${SUBSCRIPTION_PLANS[selectedPlan].name} ÌîåÎûúÏùÑ Íµ¨ÎèÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,
      [
        { text: "Ï∑®ÏÜå", style: "cancel" },
        {
          text: "Íµ¨ÎèÖÌïòÍ∏∞",
          onPress: async () => {
            try {
              await inAppPurchaseService.purchaseSubscription(
                selectedPlan,
                false
              );
            } catch (error) {
              console.error("Subscription error:", error);
              Alert.alert(
                "Íµ¨ÎèÖ Ïã§Ìå®",
                "Íµ¨ÎèÖ Ï≤òÎ¶¨ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
                [{ text: "ÌôïÏù∏" }]
              );
            }
          },
        },
      ]
    );
  };

  const styles = createStyles(colors, isDark);

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Icon name="arrow-back" size={24} color={colors.text.primary} />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>
          {activeTab === "subscription"
            ? "Íµ¨ÎèÖ ÌîåÎûú"
            : activeTab === "tokens"
            ? "ÌÜ†ÌÅ∞ Íµ¨Îß§"
            : "Î¨¥Î£å ÌÜ†ÌÅ∞"}
        </Text>
        <TouchableOpacity
          style={styles.headerButton}
          onPress={() => setShowEarnTokenModal(true)}
        >
          <Icon name="flash-on" size={20} color={colors.primary} />
          <Text style={styles.currentTokens}>{currentTokens}</Text>
        </TouchableOpacity>
      </View>

      <View style={styles.tabContainer}>
        <TouchableOpacity
          style={[
            styles.tabButton,
            activeTab === "subscription" && styles.activeTab,
          ]}
          onPress={() => setActiveTab("subscription")}
        >
          <Icon
            name="workspace-premium"
            size={20}
            color={
              activeTab === "subscription"
                ? colors.primary
                : colors.text.secondary
            }
          />
          <Text
            style={[
              styles.tabText,
              activeTab === "subscription" && styles.activeTabText,
            ]}
          >
            Íµ¨ÎèÖ ÌîåÎûú
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.tabButton, activeTab === "tokens" && styles.activeTab]}
          onPress={() => setActiveTab("tokens")}
        >
          <Icon
            name="flash-on"
            size={20}
            color={
              activeTab === "tokens" ? colors.primary : colors.text.secondary
            }
          />
          <Text
            style={[
              styles.tabText,
              activeTab === "tokens" && styles.activeTabText,
            ]}
          >
            ÌÜ†ÌÅ∞ Íµ¨Îß§
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.tabButton, activeTab === "manage" && styles.activeTab]}
          onPress={() => setActiveTab("manage")}
        >
          <Icon
            name="account-balance-wallet"
            size={20}
            color={
              activeTab === "manage" ? colors.primary : colors.text.secondary
            }
          />
          <Text
            style={[
              styles.tabText,
              activeTab === "manage" && styles.activeTabText,
            ]}
          >
            Î¨¥Î£å ÌÜ†ÌÅ∞
          </Text>
        </TouchableOpacity>
      </View>

      {activeTab === "subscription" ? (
        <>
          <ModernSubscriptionView
            selectedPlan={selectedPlan}
            currentPlan={currentPlan}
            onSelectPlan={setSelectedPlan}
            onSubscribe={handleSubscribe}
            colors={colors}
            isDark={isDark}
          />
          <View style={styles.bottomCTA}>
            <TouchableOpacity
              style={[
                styles.subscribeButton,
                {
                  backgroundColor:
                    selectedPlan === "free"
                      ? colors.text.tertiary
                      : selectedPlan === "premium"
                      ? "#8B5CF6"
                      : "#F59E0B",
                },
              ]}
              onPress={handleSubscribe}
              activeOpacity={0.8}
            >
              <Text style={styles.subscribeButtonText}>
                {selectedPlan === "free"
                  ? "Î¨¥Î£åÎ°ú Í≥ÑÏÜçÌïòÍ∏∞"
                  : BRAND.cta.download}{" "}
                {/* CTA Ï†ÅÏö© */}
              </Text>
            </TouchableOpacity>

            <Text style={styles.legalText}>
              Íµ¨ÎèÖÏùÄ Ïñ∏Ï†úÎì†ÏßÄ Ï∑®ÏÜåÌï† Ïàò ÏûàÏäµÎãàÎã§
            </Text>
          </View>
        </>
      ) : activeTab === "tokens" ? (
        <TokenPurchaseView
          onPurchase={async (packageId: string) => {
            try {
              await inAppPurchaseService.purchaseTokens(packageId);
            } catch (error) {
              console.error("Token purchase error:", error);
            }
          }}
          colors={colors}
          isDark={isDark}
        />
      ) : activeTab === "manage" ? (
        <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
          <View style={styles.heroSection}>
            <Text style={styles.heroTitle}>Î¨¥Î£å ÌÜ†ÌÅ∞ Î∞õÍ∏∞</Text>
            <Text style={styles.heroSubtitle}>{BRAND.slogans.busy}</Text>
          </View>

          {/* ÌòÑÏû¨ Î≥¥Ïú† ÌÜ†ÌÅ∞ Ï†ïÎ≥¥ ÌëúÏãú Ï†úÍ±∞ - Î∂àÌïÑÏöîÌïú Ï§ëÎ≥µ Ï†ïÎ≥¥ */}

          {/* Î¨¥Î£å ÌÜ†ÌÅ∞ Î∞õÍ∏∞ Î™©Î°ù */}
          <View style={styles.earnTokensSection}>
            <View style={styles.earnTokensList}>
              <TouchableOpacity
                style={styles.earnTokenItem}
                onPress={() => handleWatchAd()}
              >
                <View
                  style={[
                    styles.earnTokenIcon,
                    { backgroundColor: "#8B5CF6" + "20" },
                  ]}
                >
                  <Icon name="play-circle" size={24} color="#8B5CF6" />
                </View>
                <View style={styles.earnTokenInfo}>
                  <Text style={styles.earnTokenTitle}>Í¥ëÍ≥† Î≥¥Í∏∞</Text>
                  <Text style={styles.earnTokenDesc}>
                    +2 ÌÜ†ÌÅ∞ ({adStats.remainingToday}/{10}
                    Ìöå ÎÇ®Ïùå)
                  </Text>
                </View>
                <Icon
                  name="chevron-right"
                  size={20}
                  color={colors.text.tertiary}
                />
              </TouchableOpacity>

              <TouchableOpacity
                style={styles.earnTokenItem}
                onPress={() => handleDailyCheck()}
              >
                <View
                  style={[
                    styles.earnTokenIcon,
                    { backgroundColor: "#10B981" + "20" },
                  ]}
                >
                  <Icon name="event-available" size={24} color="#10B981" />
                </View>
                <View style={styles.earnTokenInfo}>
                  <Text style={styles.earnTokenTitle}>ÏùºÏùº Ï∂úÏÑù</Text>
                  <Text style={styles.earnTokenDesc}>+1 ÌÜ†ÌÅ∞ (Ïò§Îäò Í∞ÄÎä•)</Text>
                </View>
                <Icon
                  name="chevron-right"
                  size={20}
                  color={colors.text.tertiary}
                />
              </TouchableOpacity>

              <TouchableOpacity
                style={styles.earnTokenItem}
                onPress={() => handleShareSNS()}
              >
                <View
                  style={[
                    styles.earnTokenIcon,
                    { backgroundColor: "#EC4899" + "20" },
                  ]}
                >
                  <Icon name="share" size={24} color="#EC4899" />
                </View>
                <View style={styles.earnTokenInfo}>
                  <Text style={styles.earnTokenTitle}>SNS Í≥µÏú†</Text>
                  <Text style={styles.earnTokenDesc}>+3 ÌÜ†ÌÅ∞ (1/1Ìöå ÎÇ®Ïùå)</Text>
                </View>
                <Icon
                  name="chevron-right"
                  size={20}
                  color={colors.text.tertiary}
                />
              </TouchableOpacity>

              <TouchableOpacity
                style={styles.earnTokenItem}
                onPress={() => handleInviteFriend()}
              >
                <View
                  style={[
                    styles.earnTokenIcon,
                    { backgroundColor: "#F59E0B" + "20" },
                  ]}
                >
                  <Icon name="person-add" size={24} color="#F59E0B" />
                </View>
                <View style={styles.earnTokenInfo}>
                  <Text style={styles.earnTokenTitle}>ÏπúÍµ¨ Ï¥àÎåÄ</Text>
                  <Text style={styles.earnTokenDesc}>+5 ÌÜ†ÌÅ∞ (ÏπúÍµ¨Îãπ)</Text>
                </View>
                <Icon
                  name="chevron-right"
                  size={20}
                  color={colors.text.tertiary}
                />
              </TouchableOpacity>

              <TouchableOpacity
                style={styles.earnTokenItem}
                onPress={() => handleRateApp()}
              >
                <View
                  style={[
                    styles.earnTokenIcon,
                    { backgroundColor: "#6366F1" + "20" },
                  ]}
                >
                  <Icon name="star" size={24} color="#6366F1" />
                </View>
                <View style={styles.earnTokenInfo}>
                  <Text style={styles.earnTokenTitle}>Ïï± ÌèâÍ∞ÄÌïòÍ∏∞</Text>
                  <Text style={styles.earnTokenDesc}>+10 ÌÜ†ÌÅ∞ (1Ìöå)</Text>
                </View>
                <Icon
                  name="chevron-right"
                  size={20}
                  color={colors.text.tertiary}
                />
              </TouchableOpacity>
            </View>

            {/* Ï∂îÍ∞Ä ÏïàÎÇ¥ */}
            <View style={styles.earnTokenTip}>
              <Icon name="lightbulb-outline" size={20} color={colors.primary} />
              <Text style={styles.earnTokenTipText}>
                Î¨¥Î£å ÌîåÎûú ÏÇ¨Ïö©ÏûêÎäî Îß§Ïùº ÏûêÏ†ïÏóê 10Í∞úÏùò ÌÜ†ÌÅ∞Ïù¥ ÏûêÎèô Ï∂©Ï†ÑÎê©ÎãàÎã§
              </Text>
            </View>

            {/* ÌîÑÎ¶¨ÎØ∏ÏóÑ/ÌîÑÎ°ú ÏÇ¨Ïö©Ïûê ÏïàÎÇ¥ */}
            {realSubscriptionPlan !== "free" && (
              <View style={styles.premiumNotice}>
                <Icon
                  name="workspace-premium"
                  size={20}
                  color={colors.primary}
                />
                <Text style={styles.premiumNoticeText}>
                  {realSubscriptionPlan === "premium"
                    ? "ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌöåÏõêÏùÄ Îß§Ïõî 100Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§"
                    : "ÌîÑÎ°ú ÌöåÏõêÏùÄ Î¨¥Ï†úÌïú ÌÜ†ÌÅ∞ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§"}
                </Text>
              </View>
            )}
          </View>

          <View style={styles.bottomSpace} />
        </ScrollView>
      ) : null}

      <EarnTokenModal
        visible={showEarnTokenModal}
        onClose={() => {
          setShowEarnTokenModal(false);
          loadTokenStats();
        }}
        onTokensEarned={handleEarnTokens}
      />
    </SafeAreaView>
  );
};

const createStyles = (colors: any, isDark: boolean) => {
  return StyleSheet.create({
    container: {
      flex: 1,
      backgroundColor: colors.background,
    },
    header: {
      flexDirection: "row",
      alignItems: "center",
      justifyContent: "space-between",
      paddingHorizontal: SPACING.medium,
      paddingVertical: SPACING.medium,
      borderBottomWidth: 1,
      borderBottomColor: colors.border,
    },
    backButton: {
      width: 40,
      height: 40,
      justifyContent: "center",
      alignItems: "center",
    },
    headerTitle: {
      fontSize: 18,
      fontWeight: "600",
      color: colors.text.primary,
    },
    content: {
      flex: 1,
    },
    headerButton: {
      flexDirection: "row",
      alignItems: "center",
      backgroundColor: colors.primary + "20",
      paddingHorizontal: 12,
      paddingVertical: 6,
      borderRadius: 16,
      gap: 4,
    },
    currentTokens: {
      fontSize: 14,
      fontWeight: "700",
      color: colors.primary,
    },
    tokenInfoBanner: {
      flexDirection: "row",
      alignItems: "center",
      backgroundColor: colors.primary + "10",
      marginHorizontal: SPACING.large,
      marginBottom: SPACING.large,
      padding: SPACING.medium,
      borderRadius: 12,
      gap: SPACING.small,
    },
    tokenInfoText: {
      fontSize: 13,
      color: colors.text.primary,
      flex: 1,
      lineHeight: 18,
    },
    earnTokensSection: {
      paddingHorizontal: SPACING.large,
    },
    earnTokensList: {
      gap: SPACING.small,
    },
    earnTokenItem: {
      flexDirection: "row",
      alignItems: "center",
      backgroundColor: colors.surface,
      padding: SPACING.medium,
      borderRadius: 12,
      gap: SPACING.medium,
      borderWidth: 1,
      borderColor: colors.border,
    },
    earnTokenIcon: {
      width: 44,
      height: 44,
      borderRadius: 22,
      justifyContent: "center",
      alignItems: "center",
    },
    earnTokenInfo: {
      flex: 1,
    },
    earnTokenTitle: {
      fontSize: 14,
      fontWeight: "600",
      color: colors.text.primary,
      marginBottom: 2,
    },
    earnTokenDesc: {
      fontSize: 12,
      color: colors.text.secondary,
    },
    earnTokenTip: {
      flexDirection: "row",
      alignItems: "center",
      backgroundColor: colors.surface,
      marginTop: SPACING.large,
      padding: SPACING.medium,
      borderRadius: 12,
      gap: SPACING.small,
      borderWidth: 1,
      borderColor: colors.border,
    },
    earnTokenTipText: {
      fontSize: 13,
      color: colors.text.secondary,
      flex: 1,
      lineHeight: 18,
    },
    premiumNotice: {
      flexDirection: "row",
      alignItems: "center",
      backgroundColor: colors.primary + "10",
      marginTop: SPACING.medium,
      padding: SPACING.medium,
      borderRadius: 12,
      gap: SPACING.small,
    },
    premiumNoticeText: {
      fontSize: 13,
      color: colors.primary,
      flex: 1,
      lineHeight: 18,
      fontWeight: "500",
    },
    heroSection: {
      paddingHorizontal: SPACING.large,
      paddingTop: SPACING.large,
      paddingBottom: SPACING.xl,
    },
    heroTitle: {
      fontSize: 28,
      fontWeight: "700",
      color: colors.text.primary,
      lineHeight: 36,
      marginBottom: SPACING.small,
    },
    heroSubtitle: {
      fontSize: 16,
      color: colors.text.secondary,
      lineHeight: 24,
    },
    bottomSpace: {
      height: 100,
    },
    bottomCTA: {
      position: "absolute",
      bottom: 0,
      left: 0,
      right: 0,
      backgroundColor: colors.background,
      paddingHorizontal: SPACING.medium,
      paddingTop: SPACING.medium,
      paddingBottom: SPACING.large,
      borderTopWidth: 1,
      borderTopColor: colors.border,
    },
    subscribeButton: {
      paddingVertical: 16,
      borderRadius: 12,
      alignItems: "center",
      marginBottom: SPACING.small,
    },
    subscribeButtonText: {
      color: "#FFFFFF",
      fontSize: 16,
      fontWeight: "600",
    },
    legalText: {
      fontSize: 12,
      color: colors.text.tertiary,
      textAlign: "center",
    },
    tabContainer: {
      flexDirection: "row",
      paddingHorizontal: SPACING.medium,
      paddingVertical: SPACING.small,
      gap: SPACING.small,
      borderBottomWidth: 1,
      borderBottomColor: colors.border,
    },
    tabButton: {
      flex: 1,
      flexDirection: "row",
      alignItems: "center",
      justifyContent: "center",
      paddingVertical: SPACING.small,
      borderRadius: 8,
      gap: 6,
    },
    activeTab: {
      backgroundColor: colors.primary + "15",
    },
    tabText: {
      fontSize: 14,
      fontWeight: "500",
      color: colors.text.secondary,
    },
    activeTabText: {
      color: colors.primary,
      fontWeight: "600",
    },
  });
};

export default SubscriptionScreen;
